var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define("@nguniversal/express-engine/schematics/install/index", ["require", "exports", "@angular-devkit/core", "@angular-devkit/schematics", "@angular-devkit/schematics/tasks", "@schematics/angular/utility/config", "@schematics/angular/utility/dependencies", "@schematics/angular/utility/project", "@schematics/angular/utility/project-targets", "@schematics/angular/utility/ast-utils", "typescript", "@nguniversal/express-engine/schematics/install/utils"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    /**
     * @license
     * Copyright Google LLC All Rights Reserved.
     *
     * Use of this source code is governed by an MIT-style license that can be
     * found in the LICENSE file at https://angular.io/license
     */
    var core_1 = require("@angular-devkit/core");
    var schematics_1 = require("@angular-devkit/schematics");
    var tasks_1 = require("@angular-devkit/schematics/tasks");
    var config_1 = require("@schematics/angular/utility/config");
    var dependencies_1 = require("@schematics/angular/utility/dependencies");
    var project_1 = require("@schematics/angular/utility/project");
    var project_targets_1 = require("@schematics/angular/utility/project-targets");
    var ast_utils_1 = require("@schematics/angular/utility/ast-utils");
    var ts = require("typescript");
    var utils_1 = require("@nguniversal/express-engine/schematics/install/utils");
    // TODO(CaerusKaru): make these configurable
    var BROWSER_DIST = 'dist/browser';
    var SERVER_DIST = 'dist/server';
    function getClientProject(host, options) {
        var workspace = config_1.getWorkspace(host);
        var clientProject = workspace.projects[options.clientProject];
        if (!clientProject) {
            throw new schematics_1.SchematicsException("Client app " + options.clientProject + " not found.");
        }
        return clientProject;
    }
    function addDependenciesAndScripts(options) {
        return function (host) {
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: '@nguniversal/express-engine',
                version: '0.0.0',
            });
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: '@nguniversal/module-map-ngfactory-loader',
                version: '0.0.0',
            });
            dependencies_1.addPackageJsonDependency(host, {
                type: dependencies_1.NodeDependencyType.Default,
                name: 'express',
                version: '^4.15.2',
            });
            if (options.webpack) {
                dependencies_1.addPackageJsonDependency(host, {
                    type: dependencies_1.NodeDependencyType.Dev,
                    name: 'ts-loader',
                    version: '^5.2.0',
                });
                dependencies_1.addPackageJsonDependency(host, {
                    type: dependencies_1.NodeDependencyType.Dev,
                    name: 'webpack-cli',
                    version: '^3.1.0',
                });
            }
            var serverFileName = options.serverFileName.replace('.ts', '');
            var pkgPath = '/package.json';
            var buffer = host.read(pkgPath);
            if (buffer === null) {
                throw new schematics_1.SchematicsException('Could not find package.json');
            }
            var pkg = JSON.parse(buffer.toString());
            pkg.scripts['compile:server'] = options.webpack ?
                'webpack --config webpack.server.config.js --progress --colors' :
                "tsc -p " + serverFileName + ".tsconfig.json";
            pkg.scripts['serve:ssr'] = "node dist/" + serverFileName;
            pkg.scripts['build:ssr'] = 'npm run build:client-and-server-bundles && npm run compile:server';
            pkg.scripts['build:client-and-server-bundles'] =
                "ng build --prod && ng run " + options.clientProject + ":server:production";
            host.overwrite(pkgPath, JSON.stringify(pkg, null, 2));
            return host;
        };
    }
    function updateConfigFile(options) {
        return function (host) {
            var workspace = config_1.getWorkspace(host);
            if (!workspace.projects[options.clientProject]) {
                throw new schematics_1.SchematicsException("Client app " + options.clientProject + " not found.");
            }
            var clientProject = workspace.projects[options.clientProject];
            if (!clientProject.architect) {
                throw new Error('Client project architect not found.');
            }
            // We have to check if the project config has a server target, because
            // if the Universal step in this schematic isn't run, it can't be guaranteed
            // to exist
            if (!clientProject.architect.server) {
                return;
            }
            clientProject.architect.server.configurations = {
                production: {
                    fileReplacements: [
                        {
                            replace: 'src/environments/environment.ts',
                            with: 'src/environments/environment.prod.ts'
                        }
                    ]
                }
            };
            // TODO(CaerusKaru): make this configurable
            clientProject.architect.server.options.outputPath = SERVER_DIST;
            // TODO(CaerusKaru): make this configurable
            clientProject.architect.build.options.outputPath = BROWSER_DIST;
            var workspacePath = config_1.getWorkspacePath(host);
            host.overwrite(workspacePath, JSON.stringify(workspace, null, 2));
            return host;
        };
    }
    function addModuleMapLoader(options) {
        return function (host) {
            var clientProject = project_1.getProject(host, options.clientProject);
            var clientTargets = project_targets_1.getProjectTargets(clientProject);
            if (!clientTargets.server) {
                // If they skipped Universal schematics and don't have a server target,
                // just get out
                return;
            }
            var mainPath = core_1.normalize('/' + clientTargets.server.options.main);
            var appServerModuleRelativePath = utils_1.findAppServerModulePath(host, mainPath);
            var modulePath = core_1.normalize("/" + clientProject.root + "/src/" + appServerModuleRelativePath + ".ts");
            // Add the module map loader import
            var moduleSource = getTsSourceFile(host, modulePath);
            var importModule = 'ModuleMapLoaderModule';
            var importPath = '@nguniversal/module-map-ngfactory-loader';
            var moduleMapImportChange = ast_utils_1.insertImport(moduleSource, modulePath, importModule, importPath);
            if (moduleMapImportChange) {
                var recorder = host.beginUpdate(modulePath);
                recorder.insertLeft(moduleMapImportChange.pos, moduleMapImportChange.toAdd);
                host.commitUpdate(recorder);
            }
            // Add the module map loader module to the imports
            var importText = 'ModuleMapLoaderModule';
            moduleSource = getTsSourceFile(host, modulePath);
            var metadataChanges = ast_utils_1.addSymbolToNgModuleMetadata(moduleSource, modulePath, 'imports', importText);
            if (metadataChanges) {
                var recorder_1 = host.beginUpdate(modulePath);
                metadataChanges.forEach(function (change) {
                    recorder_1.insertRight(change.pos, change.toAdd);
                });
                host.commitUpdate(recorder_1);
            }
        };
    }
    function getTsSourceFile(host, path) {
        var buffer = host.read(path);
        if (!buffer) {
            throw new schematics_1.SchematicsException("Could not read file (" + path + ").");
        }
        var content = buffer.toString();
        var source = ts.createSourceFile(path, content, ts.ScriptTarget.Latest, true);
        return source;
    }
    function default_1(options) {
        return function (host, context) {
            var clientProject = getClientProject(host, options);
            if (clientProject.projectType !== 'application') {
                throw new schematics_1.SchematicsException("Universal requires a project type of \"application\".");
            }
            if (!options.skipInstall) {
                context.addTask(new tasks_1.NodePackageInstallTask());
            }
            var rootSource = schematics_1.apply(schematics_1.url('./files/root'), [
                options.skipServer ? schematics_1.filter(function (path) { return !path.startsWith('__serverFileName'); }) : schematics_1.noop(),
                options.webpack ?
                    schematics_1.filter(function (path) { return !path.includes('tsconfig'); }) : schematics_1.filter(function (path) { return !path.startsWith('webpack'); }),
                schematics_1.template(__assign({}, core_1.strings, options, { stripTsExtension: function (s) { return s.replace(/\.ts$/, ''); }, getBrowserDistDirectory: function () { return BROWSER_DIST; }, getServerDistDirectory: function () { return SERVER_DIST; } }))
            ]);
            return schematics_1.chain([
                options.skipUniversal ?
                    schematics_1.noop() : schematics_1.externalSchematic('@schematics/angular', 'universal', options),
                updateConfigFile(options),
                schematics_1.mergeWith(rootSource),
                addDependenciesAndScripts(options),
                addModuleMapLoader(options),
            ]);
        };
    }
    exports.default = default_1;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vIiwic291cmNlcyI6WyJtb2R1bGVzL2V4cHJlc3MtZW5naW5lL3NjaGVtYXRpY3MvaW5zdGFsbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBQUE7Ozs7OztPQU1HO0lBQ0gsNkNBQXNFO0lBQ3RFLHlEQWFvQztJQUNwQywwREFBd0U7SUFDeEUsNkRBQWtGO0lBRWxGLHlFQUdrRDtJQUVsRCwrREFBK0Q7SUFDL0QsK0VBR3FEO0lBRXJELG1FQUFnRztJQUNoRywrQkFBaUM7SUFDakMsOEVBQWdEO0lBRWhELDRDQUE0QztJQUM1QyxJQUFNLFlBQVksR0FBRyxjQUFjLENBQUM7SUFDcEMsSUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDO0lBRWxDLFNBQVMsZ0JBQWdCLENBQ3ZCLElBQVUsRUFBRSxPQUF5QjtRQUVyQyxJQUFNLFNBQVMsR0FBRyxxQkFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JDLElBQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsTUFBTSxJQUFJLGdDQUFtQixDQUFDLGdCQUFjLE9BQU8sQ0FBQyxhQUFhLGdCQUFhLENBQUMsQ0FBQztTQUNqRjtRQUVELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxTQUFTLHlCQUF5QixDQUFDLE9BQXlCO1FBQzFELE9BQU8sVUFBQyxJQUFVO1lBQ2hCLHVDQUF3QixDQUFDLElBQUksRUFBRTtnQkFDN0IsSUFBSSxFQUFFLGlDQUFrQixDQUFDLE9BQU87Z0JBQ2hDLElBQUksRUFBRSw2QkFBNkI7Z0JBQ25DLE9BQU8sRUFBRSxtQkFBbUI7YUFDN0IsQ0FBQyxDQUFDO1lBQ0gsdUNBQXdCLENBQUMsSUFBSSxFQUFFO2dCQUM3QixJQUFJLEVBQUUsaUNBQWtCLENBQUMsT0FB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QUEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxFQUExQixDQUEwQixDQUFDLENBQUMsQ0FBQyxDQUFDLG1CQUFNLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQTNCLENBQTJCLENBQUM7Z0JBQzFGLHFCQUFRLGNBQ0gsY0FBTyxFQUNQLE9BQWlCLElBQ3BCLGdCQUFnQixFQUFFLFVBQUMsQ0FBUyxJQUFLLE9BQUEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQXRCLENBQXNCLEVBQ3ZELHVCQUF1QixFQUFFLGNBQU0sT0FBQSxZQUFZLEVBQVosQ0FBWSxFQUMzQyxzQkFBc0IsRUFBRSxjQUFNLE9BQUEsV0FBVyxFQUFYLENBQVcsSUFDekM7YUFDSCxDQUFDLENBQUM7WUFFSCxPQUFPLGtCQUFLLENBQUM7Z0JBQ1gsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUNyQixpQkFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLDhCQUFpQixDQUFDLHFCQUFxQixFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUM7Z0JBQ3pFLGdCQUFnQixDQUFDLE9BQU8sQ0FBQztnQkFDekIsc0JBQVMsQ0FBQyxVQUFVLENBQUM7Z0JBQ3JCLHlCQUF5QixDQUFDLE9BQU8sQ0FBQztnQkFDbEMsa0JBQWtCLENBQUMsT0FBTyxDQUFDO2FBQzVCLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztJQUNKLENBQUM7SUFqQ0QsNEJBaUNDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQge2V4cGVyaW1lbnRhbCwgc3RyaW5ncywgbm9ybWFsaXplfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQge1xuICBhcHBseSxcbiAgY2hhaW4sXG4gIGV4dGVybmFsU2NoZW1hdGljLFxuICBmaWx0ZXIsXG4gIG1lcmdlV2l0aCxcbiAgbm9vcCxcbiAgUnVsZSxcbiAgU2NoZW1hdGljQ29udGV4dCxcbiAgU2NoZW1hdGljc0V4Y2VwdGlvbixcbiAgdGVtcGxhdGUsXG4gIFRyZWUsXG4gIHVybCxcbn0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MnO1xuaW1wb3J0IHtOb2RlUGFja2FnZUluc3RhbGxUYXNrfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XG5pbXBvcnQge2dldFdvcmtzcGFjZSwgZ2V0V29ya3NwYWNlUGF0aH0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2NvbmZpZyc7XG5pbXBvcnQge1NjaGVtYSBhcyBVbml2ZXJzYWxPcHRpb25zfSBmcm9tICcuL3NjaGVtYSc7XG5pbXBvcnQge1xuICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3ksXG4gIE5vZGVEZXBlbmRlbmN5VHlwZSxcbn0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2RlcGVuZGVuY2llcyc7XG5pbXBvcnQge0Jyb3dzZXJCdWlsZGVyT3B0aW9uc30gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L3dvcmtzcGFjZS1tb2RlbHMnO1xuaW1wb3J0IHtnZXRQcm9qZWN0fSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvcHJvamVjdCc7XG5pbXBvcnQge1xuICBnZXRQcm9qZWN0VGFyZ2V0cyxcbiAgdGFyZ2V0QnVpbGROb3RGb3VuZEVycm9yLFxufSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvcHJvamVjdC10YXJnZXRzJztcbmltcG9ydCB7SW5zZXJ0Q2hhbmdlfSBmcm9tICdAc2NoZW1hdGljcy9hbmd1bGFyL3V0aWxpdHkvY2hhbmdlJztcbmltcG9ydCB7YWRkU3ltYm9sVG9OZ01vZHVsZU1ldGFkYXRhLCBpbnNlcnRJbXBvcnR9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9hc3QtdXRpbHMnO1xuaW1wb3J0ICogYXMgdHMgZnJvbSAndHlwZXNjcmlwdCc7XG5pbXBvcnQge2ZpbmRBcHBTZXJ2ZXJNb2R1bGVQYXRofSBmcm9tICcuL3V0aWxzJztcblxuLy8gVE9ETyhDYWVydXNLYXJ1KTogbWFrZSB0aGVzZSBjb25maWd1cmFibGVcbmNvbnN0IEJST1dTRVJfRElTVCA9ICdkaXN0L2Jyb3dzZXInO1xuY29uc3QgU0VSVkVSX0RJU1QgPSAnZGlzdC9zZXJ2ZXInO1xuXG5mdW5jdGlvbiBnZXRDbGllbnRQcm9qZWN0KFxuICBob3N0OiBUcmVlLCBvcHRpb25zOiBVbml2ZXJzYWxPcHRpb25zLFxuKTogZXhwZXJpbWVudGFsLndvcmtzcGFjZS5Xb3Jrc3BhY2VQcm9qZWN0IHtcbiAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKGhvc3QpO1xuICBjb25zdCBjbGllbnRQcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMuY2xpZW50UHJvamVjdF07XG4gIGlmICghY2xpZW50UHJvamVjdCkge1xuICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKGBDbGllbnQgYXBwICR7b3B0aW9ucy5jbGllbnRQcm9qZWN0fSBub3QgZm91bmQuYCk7XG4gIH1cblxuICByZXR1cm4gY2xpZW50UHJvamVjdDtcbn1cblxuZnVuY3Rpb24gYWRkRGVwZW5kZW5jaWVzQW5kU2NyaXB0cyhvcHRpb25zOiBVbml2ZXJzYWxPcHRpb25zKTogUnVsZSB7XG4gIHJldHVybiAoaG9zdDogVHJlZSkgPT4ge1xuICAgIGFkZFBhY2thZ2VKc29uRGVwZW5kZW5jeShob3N0LCB7XG4gICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGVmYXVsdCxcbiAgICAgIG5hbWU6ICdAbmd1bml2ZXJzYWwvZXhwcmVzcy1lbmdpbmUnLFxuICAgICAgdmVyc2lvbjogJzAuMC4wLVBMQUNFSE9MREVSJyxcbiAgICB9KTtcbiAgICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3koaG9zdCwge1xuICAgICAgdHlwZTogTm9kZURlcGVuZGVuY3lUeXBlLkRlZmF1bHQsXG4gICAgICBuYW1lOiAnQG5ndW5pdmVyc2FsL21vZHVsZS1tYXAtbmdmYWN0b3J5LWxvYWRlcicsXG4gICAgICB2ZXJzaW9uOiAnMC4wLjAtUExBQ0VIT0xERVInLFxuICAgIH0pO1xuICAgIGFkZFBhY2thZ2VKc29uRGVwZW5kZW5jeShob3N0LCB7XG4gICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGVmYXVsdCxcbiAgICAgIG5hbWU6ICdleHByZXNzJyxcbiAgICAgIHZlcnNpb246ICdFWFBSRVNTX1ZFUlNJT04nLFxuICAgIH0pO1xuXG4gICAgaWYgKG9wdGlvbnMud2VicGFjaykge1xuICAgICAgYWRkUGFja2FnZUpzb25EZXBlbmRlbmN5KGhvc3QsIHtcbiAgICAgICAgdHlwZTogTm9kZURlcGVuZGVuY3lUeXBlLkRldixcbiAgICAgICAgbmFtZTogJ3RzLWxvYWRlcicsXG4gICAgICAgIHZlcnNpb246ICdeNS4yLjAnLFxuICAgICAgfSk7XG4gICAgICBhZGRQYWNrYWdlSnNvbkRlcGVuZGVuY3koaG9zdCwge1xuICAgICAgICB0eXBlOiBOb2RlRGVwZW5kZW5jeVR5cGUuRGV2LFxuICAgICAgICBuYW1lOiAnd2VicGFjay1jbGknLFxuICAgICAgICB2ZXJzaW9uOiAnXjMuMS4wJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHNlcnZlckZpbGVOYW1lID0gb3B0aW9ucy5zZXJ2ZXJGaWxlTmFtZS5yZXBsYWNlKCcudHMnLCAnJyk7XG4gICAgY29uc3QgcGtnUGF0aCA9ICcvcGFja2FnZS5qc29uJztcbiAgICBjb25zdCBidWZmZXIgPSBob3N0LnJlYWQocGtnUGF0aCk7XG4gICAgaWYgKGJ1ZmZlciA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IFNjaGVtYXRpY3NFeGNlcHRpb24oJ0NvdWxkIG5vdCBmaW5kIHBhY2thZ2UuanNvbicpO1xuICAgIH1cblxuICAgIGNvbnN0IHBrZyA9IEpTT04ucGFyc2UoYnVmZmVyLnRvU3RyaW5nKCkpO1xuXG4gICAgcGtnLnNjcmlwdHNbJ2NvbXBpbGU6c2VydmVyJ10gPSBvcHRpb25zLndlYnBhY2sgP1xuICAgICAgJ3dlYnBhY2sgLS1jb25maWcgd2VicGFjay5zZXJ2ZXIuY29uZmlnLmpzIC0tcHJvZ3Jlc3MgLS1jb2xvcnMnIDpcbiAgICAgIGB0c2MgLXAgJHtzZXJ2ZXJGaWxlTmFtZX0udHNjb25maWcuanNvbmA7XG4gICAgcGtnLnNjcmlwdHNbJ3NlcnZlOnNzciddID0gYG5vZGUgZGlzdC8ke3NlcnZlckZpbGVOYW1lfWA7XG4gICAgcGtnLnNjcmlwdHNbJ2J1aWxkOnNzciddID0gJ25wbSBydW4gYnVpbGQ6Y2xpZW50LWFuZC1zZXJ2ZXItYnVuZGxlcyAmJiBucG0gcnVuIGNvbXBpbGU6c2VydmVyJztcbiAgICBwa2cuc2NyaXB0c1snYnVpbGQ6Y2xpZW50LWFuZC1zZXJ2ZXItYnVuZGxlcyddID1cbiAgICAgIGBuZyBidWlsZCAtLXByb2QgJiYgbmcgcnVuICR7b3B0aW9ucy5jbGllbnRQcm9qZWN0fTpzZXJ2ZXI6cHJvZHVjdGlvbmA7XG5cbiAgICBob3N0Lm92ZXJ3cml0ZShwa2dQYXRoLCBKU09OLnN0cmluZ2lmeShwa2csIG51bGwsIDIpKTtcblxuICAgIHJldHVybiBob3N0O1xuICB9O1xufVxuXG5mdW5jdGlvbiB1cGRhdGVDb25maWdGaWxlKG9wdGlvbnM6IFVuaXZlcnNhbE9wdGlvbnMpOiBSdWxlIHtcbiAgcmV0dXJuIChob3N0OiBUcmVlKSA9PiB7XG4gICAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKGhvc3QpO1xuICAgIGlmICghd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMuY2xpZW50UHJvamVjdF0pIHtcbiAgICAgIHRocm93IG5ldyBTY2hlbWF0aWNzRXhjZXB0aW9uKGBDbGllbnQgYXBwICR7b3B0aW9ucy5jbGllbnRQcm9qZWN0fSBub3QgZm91bmQuYCk7XG4gICAgfVxuXG4gICAgY29uc3QgY2xpZW50UHJvamVjdCA9IHdvcmtzcGFjZS5wcm9qZWN0c1tvcHRpb25zLmNsaWVudFByb2plY3RdO1xuICAgIGlmICghY2xpZW50UHJvamVjdC5hcmNoaXRlY3QpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2xpZW50IHByb2plY3QgYXJjaGl0ZWN0IG5vdCBmb3VuZC4nKTtcbiAgICB9XG5cbiAgICAvLyBXZSBoYXZlIHRvIGNoZWNrIGlmIHRoZSBwcm9qZWN0IGNvbmZpZyBoYXMgYSBzZXJ2ZXIgdGFyZ2V0LCBiZWNhdXNlXG4gICAgLy8gaWYgdGhlIFVuaXZlcnNhbCBzdGVwIGluIHRoaXMgc2NoZW1hdGljIGlzbid0IHJ1biwgaXQgY2FuJ3QgYmUgZ3VhcmFudGVlZFxuICAgIC8vIHRvIGV4aXN0XG4gICAgaWYgKCFjbGllbnRQcm9qZWN0LmFyY2hpdGVjdC5zZXJ2ZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjbGllbnRQcm9qZWN0LmFyY2hpdGVjdC5zZXJ2ZXIuY29uZmlndXJhdGlvbnMgPSB7XG4gICAgICBwcm9kdWN0aW9uOiB7XG4gICAgICAgIGZpbGVSZXBsYWNlbWVudHM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXBsYWNlOiAnc3JjL2Vudmlyb25tZW50cy9lbnZpcm9ubWVudC50cycsXG4gICAgICAgICAgICB3aXRoOiAnc3JjL2Vudmlyb25tZW50cy9lbnZpcm9ubWVudC5wcm9kLnRzJ1xuICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgICAgfVxuICAgIH07XG4gICAgLy8gVE9ETyhDYWVydXNLYXJ1KTogbWFrZSB0aGlzIGNvbmZpZ3VyYWJsZVxuICAgIGNsaWVudFByb2plY3QuYXJjaGl0ZWN0LnNlcnZlci5vcHRpb25zLm91dHB1dFBhdGggPSBTRVJWRVJfRElTVDtcbiAgICAvLyBUT0RPKENhZXJ1c0thcnUpOiBtYWtlIHRoaXMgY29uZmlndXJhYmxlXG4gICAgKGNsaWVudFByb2plY3QuYXJjaGl0ZWN0LmJ1aWxkLm9wdGlvbnMgYXMgQnJvd3NlckJ1aWxkZXJPcHRpb25zKS5vdXRwdXRQYXRoID0gQlJPV1NFUl9ESVNUO1xuXG4gICAgY29uc3Qgd29ya3NwYWNlUGF0aCA9IGdldFdvcmtzcGFjZVBhdGgoaG9zdCk7XG5cbiAgICBob3N0Lm92ZXJ3cml0ZSh3b3Jrc3BhY2VQYXRoLCBKU09OLnN0cmluZ2lmeSh3b3Jrc3BhY2UsIG51bGwsIDIpKTtcblxuICAgIHJldHVybiBob3N0O1xuICB9O1xufVxuXG5mdW5jdGlvbiBhZGRNb2R1bGVNYXBMb2FkZXIob3B0aW9uczogVW5pdmVyc2FsT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gKGhvc3Q6IFRyZWUpID0+IHtcbiAgICBjb25zdCBjbGllbnRQcm9qZWN0ID0gZ2V0UHJvamVjdChob3N0LCBvcHRpb25zLmNsaWVudFByb2plY3QpO1xuICAgIGNvbnN0IGNsaWVudFRhcmdldHMgPSBnZXRQcm9qZWN0VGFyZ2V0cyhjbGllbnRQcm9qZWN0KTtcbiAgICBpZiAoIWNsaWVudFRhcmdldHMuc2VydmVyKSB7XG4gICAgICAvLyBJZiB0aGV5IHNraXBwZWQgVW5pdmVyc2FsIHNjaGVtYXRpY3MgYW5kIGRvbid0IGhhdmUgYSBzZXJ2ZXIgdGFyZ2V0LFxuICAgICAgLy8ganVzdCBnZXQgb3V0XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG1haW5QYXRoID0gbm9ybWFsaXplKCcvJyArIGNsaWVudFRhcmdldHMuc2VydmVyLm9wdGlvbnMubWFpbik7XG5cbiAgICBjb25zdCBhcHBTZXJ2ZXJNb2R1bGVSZWxhdGl2ZVBhdGggPSBmaW5kQXBwU2VydmVyTW9kdWxlUGF0aChob3N0LCBtYWluUGF0aCk7XG4gICAgY29uc3QgbW9kdWxlUGF0aCA9IG5vcm1hbGl6ZShcbiAgICAgIGAvJHtjbGllbnRQcm9qZWN0LnJvb3R9L3NyYy8ke2FwcFNlcnZlck1vZHVsZVJlbGF0aXZlUGF0aH0udHNgKTtcblxuICAgIC8vIEFkZCB0aGUgbW9kdWxlIG1hcCBsb2FkZXIgaW1wb3J0XG4gICAgbGV0IG1vZHVsZVNvdXJjZSA9IGdldFRzU291cmNlRmlsZShob3N0LCBtb2R1bGVQYXRoKTtcbiAgICBjb25zdCBpbXBvcnRNb2R1bGUgPSAnTW9kdWxlTWFwTG9hZGVyTW9kdWxlJztcbiAgICBjb25zdCBpbXBvcnRQYXRoID0gJ0BuZ3VuaXZlcnNhbC9tb2R1bGUtbWFwLW5nZmFjdG9yeS1sb2FkZXInO1xuICAgIGNvbnN0IG1vZHVsZU1hcEltcG9ydENoYW5nZSA9IGluc2VydEltcG9ydChtb2R1bGVTb3VyY2UsIG1vZHVsZVBhdGgsIGltcG9ydE1vZHVsZSxcbiAgICAgIGltcG9ydFBhdGgpIGFzIEluc2VydENoYW5nZTtcbiAgICBpZiAobW9kdWxlTWFwSW1wb3J0Q2hhbmdlKSB7XG4gICAgICBjb25zdCByZWNvcmRlciA9IGhvc3QuYmVnaW5VcGRhdGUobW9kdWxlUGF0aCk7XG4gICAgICByZWNvcmRlci5pbnNlcnRMZWZ0KG1vZHVsZU1hcEltcG9ydENoYW5nZS5wb3MsIG1vZHVsZU1hcEltcG9ydENoYW5nZS50b0FkZCk7XG4gICAgICBob3N0LmNvbW1pdFVwZGF0ZShyZWNvcmRlcik7XG4gICAgfVxuXG4gICAgLy8gQWRkIHRoZSBtb2R1bGUgbWFwIGxvYWRlciBtb2R1bGUgdG8gdGhlIGltcG9ydHNcbiAgICBjb25zdCBpbXBvcnRUZXh0ID0gJ01vZHVsZU1hcExvYWRlck1vZHVsZSc7XG4gICAgbW9kdWxlU291cmNlID0gZ2V0VHNTb3VyY2VGaWxlKGhvc3QsIG1vZHVsZVBhdGgpO1xuICAgIGNvbnN0IG1ldGFkYXRhQ2hhbmdlcyA9IGFkZFN5bWJvbFRvTmdNb2R1bGVNZXRhZGF0YShcbiAgICAgIG1vZHVsZVNvdXJjZSwgbW9kdWxlUGF0aCwgJ2ltcG9ydHMnLCBpbXBvcnRUZXh0KTtcbiAgICBpZiAobWV0YWRhdGFDaGFuZ2VzKSB7XG4gICAgICBjb25zdCByZWNvcmRlciA9IGhvc3QuYmVnaW5VcGRhdGUobW9kdWxlUGF0aCk7XG4gICAgICBtZXRhZGF0YUNoYW5nZXMuZm9yRWFjaCgoY2hhbmdlOiBJbnNlcnRDaGFuZ2UpID0+IHtcbiAgICAgICAgcmVjb3JkZXIuaW5zZXJ0UmlnaHQoY2hhbmdlLnBvcywgY2hhbmdlLnRvQWRkKTtcbiAgICAgIH0pO1xuICAgICAgaG9zdC5jb21taXRVcGRhdGUocmVjb3JkZXIpO1xuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0VHNTb3VyY2VGaWxlKGhvc3Q6IFRyZWUsIHBhdGg6IHN0cmluZyk6IHRzLlNvdXJjZUZpbGUge1xuICBjb25zdCBidWZmZXIgPSBob3N0LnJlYWQocGF0aCk7XG4gIGlmICghYnVmZmVyKSB7XG4gICAgdGhyb3cgbmV3IFNjaGVtYXRpY3NFeGNlcHRpb24oYENvdWxkIG5vdCByZWFkIGZpbGUgKCR7cGF0aH0pLmApO1xuICB9XG4gIGNvbnN0IGNvbnRlbnQgPSBidWZmZXIudG9TdHJpbmcoKTtcbiAgY29uc3Qgc291cmNlID0gdHMuY3JlYXRlU291cmNlRmlsZShwYXRoLCBjb250ZW50LCB0cy5TY3JpcHRUYXJnZXQuTGF0ZXN0LCB0cnVlKTtcblxuICByZXR1cm4gc291cmNlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAob3B0aW9uczogVW5pdmVyc2FsT3B0aW9ucyk6IFJ1bGUge1xuICByZXR1cm4gKGhvc3Q6IFRyZWUsIGNvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcbiAgICBjb25zdCBjbGllbnRQcm9qZWN0ID0gZ2V0Q2xpZW50UHJvamVjdChob3N0LCBvcHRpb25zKTtcbiAgICBpZiAoY2xpZW50UHJvamVjdC5wcm9qZWN0VHlwZSAhPT0gJ2FwcGxpY2F0aW9uJykge1xuICAgICAgdGhyb3cgbmV3IFNjaGVtYXRpY3NFeGNlcHRpb24oYFVuaXZlcnNhbCByZXF1aXJlcyBhIHByb2plY3QgdHlwZSBvZiBcImFwcGxpY2F0aW9uXCIuYCk7XG4gICAgfVxuXG4gICAgaWYgKCFvcHRpb25zLnNraXBJbnN0YWxsKSB7XG4gICAgICBjb250ZXh0LmFkZFRhc2sobmV3IE5vZGVQYWNrYWdlSW5zdGFsbFRhc2soKSk7XG4gICAgfVxuXG4gICAgY29uc3Qgcm9vdFNvdXJjZSA9IGFwcGx5KHVybCgnLi9maWxlcy9yb290JyksIFtcbiAgICAgIG9wdGlvbnMuc2tpcFNlcnZlciA/IGZpbHRlcihwYXRoID0+ICFwYXRoLnN0YXJ0c1dpdGgoJ19fc2VydmVyRmlsZU5hbWUnKSkgOiBub29wKCksXG4gICAgICBvcHRpb25zLndlYnBhY2sgP1xuICAgICAgICBmaWx0ZXIocGF0aCA9PiAhcGF0aC5pbmNsdWRlcygndHNjb25maWcnKSkgOiBmaWx0ZXIocGF0aCA9PiAhcGF0aC5zdGFydHNXaXRoKCd3ZWJwYWNrJykpLFxuICAgICAgdGVtcGxhdGUoe1xuICAgICAgICAuLi5zdHJpbmdzLFxuICAgICAgICAuLi5vcHRpb25zIGFzIG9iamVjdCxcbiAgICAgICAgc3RyaXBUc0V4dGVuc2lvbjogKHM6IHN0cmluZykgPT4gcy5yZXBsYWNlKC9cXC50cyQvLCAnJyksXG4gICAgICAgIGdldEJyb3dzZXJEaXN0RGlyZWN0b3J5OiAoKSA9PiBCUk9XU0VSX0RJU1QsXG4gICAgICAgIGdldFNlcnZlckRpc3REaXJlY3Rvcnk6ICgpID0+IFNFUlZFUl9ESVNULFxuICAgICAgfSlcbiAgICBdKTtcblxuICAgIHJldHVybiBjaGFpbihbXG4gICAgICBvcHRpb25zLnNraXBVbml2ZXJzYWwgP1xuICAgICAgICBub29wKCkgOiBleHRlcm5hbFNjaGVtYXRpYygnQHNjaGVtYXRpY3MvYW5ndWxhcicsICd1bml2ZXJzYWwnLCBvcHRpb25zKSxcbiAgICAgIHVwZGF0ZUNvbmZpZ0ZpbGUob3B0aW9ucyksXG4gICAgICBtZXJnZVdpdGgocm9vdFNvdXJjZSksXG4gICAgICBhZGREZXBlbmRlbmNpZXNBbmRTY3JpcHRzKG9wdGlvbnMpLFxuICAgICAgYWRkTW9kdWxlTWFwTG9hZGVyKG9wdGlvbnMpLFxuICAgIF0pO1xuICB9O1xufVxuIl19